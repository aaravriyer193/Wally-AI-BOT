<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wally — Neon Bot Head</title>
<style>
:root{
  --bg:#07090f;
  --neon:#22b5ff;
  --size:min(70vmin,520px);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  background:var(--bg);
  display:grid;place-items:center;
}
#bot{
  width:var(--size);
  height:auto;
  filter:drop-shadow(0 0 22px rgba(34,181,255,.45));
  opacity:0;
  transform:scale(0.8);
  animation:startup 1.4s ease-out forwards;
}
@keyframes startup{
  0%{opacity:0; transform:scale(0.8);}
  70%{opacity:1; transform:scale(1.05);}
  100%{opacity:1; transform:scale(1);}
}
.face-scanlines{fill:url(#scanlines);opacity:.8;animation:scan 7s linear infinite,flicker 4s steps(80) infinite;}
@keyframes scan{from{transform:translateY(-6px)}to{transform:translateY(0)}}
@keyframes flicker{0%,100%{opacity:.85}50%{opacity:.72}}
#eyes{transform-origin:50% 50%;animation:blink 6s infinite;}
@keyframes blink{0%,88%,100%{transform:scaleY(1)}90%{transform:scaleY(.08)}}
.glow{filter:url(#glow)}
[data-state] .m{opacity:0}
[data-state="neutral"]    #m-neutral{opacity:1}
[data-state="happy"]      #m-happy{opacity:1}
[data-state="sad"]        #m-sad{opacity:1}
[data-state="surprised"] #m-o{opacity:1}
[data-state="angry"]      #m-angry{opacity:1}
[data-state="thinking"]  #m-flat{opacity:1}
.eye,.brow{transition:transform .18s ease}
[data-state="angry"]    .brow-left{transform:rotate(12deg) translate(-6,-6)}
[data-state="angry"]    .brow-right{transform:rotate(-12deg) translate(6,-6)}
[data-state="happy"]    .brow-left,[data-state="happy"] .brow-right{transform:translate(0,4)}
[data-state="sad"]      .brow-left{transform:rotate(-10deg) translate(-4,4)}
[data-state="sad"]      .brow-right{transform:rotate(10deg) translate(4,4)}
</style>
</head>
<body>

<svg id="bot" viewBox="0 0 480 560" data-state="neutral" aria-label="Neon robot head">
  <defs>
    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="4" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
    <radialGradient id="dome" cx="50%" cy="42%" r="65%">
      <stop offset="0%" stop-color="#12263d"/><stop offset="100%" stop-color="#050b15"/>
    </radialGradient>
    <linearGradient id="rim" x1="0" x2="0" y1="0" y2="1">
      <stop offset="0%" stop-color="#12243a"/><stop offset="100%" stop-color="#08101c"/>
    </linearGradient>
    <pattern id="scanlines" width="4" height="6" patternUnits="userSpaceOnUse">
      <rect width="4" height="2" fill="rgba(170,220,255,.08)"/>
    </pattern>
  </defs>

  <g id="top"><rect x="228" y="52" width="24" height="42" rx="6" fill="url(#rim)"/>
    <circle cx="240" cy="40" r="10" fill="#22b5ff" class="glow"/></g>

  <g id="head">
    <path d="M80,260 C80,140 160,60 240,60 C320,60 400,140 400,260 L400,360
               C400,440 320,500 240,500 C160,500 80,440 80,360 Z"
             fill="url(#dome)"/>
    <path d="M92,260 C92,150 166,76 240,76 C314,76 388,150 388,260 L388,354
               C388,430 320,486 240,486 C160,486 92,430 92,354 Z"
             fill="none" stroke="url(#rim)" stroke-width="18"/>
  </g>

  <g id="ears" opacity=".9">
    <rect x="52" y="250" width="30" height="90" rx="8" fill="url(#rim)"/>
    <rect x="398" y="250" width="30" height="90" rx="8" fill="url(#rim)"/>
  </g>

  <g id="face-window">
    <circle cx="240" cy="320" r="140" fill="#0a1728"/>
    <circle cx="240" cy="320" r="140" fill="none" stroke="#133558" stroke-width="8"/>
    <circle cx="240" cy="320" r="140" class="face-scanlines"/>
  </g>

  <g id="eyes">
    <rect class="brow brow-left glow"  x="160" y="248" width="70" height="8" rx="4" fill="#22b5ff"/>
    <rect class="brow brow-right glow" x="250" y="248" width="70" height="8" rx="4" fill="#22b5ff"/>
    <g class="glow">
      <ellipse class="eye" cx="195" cy="285" rx="30" ry="22" fill="#fff"/>
      <ellipse class="eye" cx="285" cy="285" rx="30" ry="22" fill="#fff"/>
      <ellipse cx="195" cy="285" rx="22" ry="16" fill="rgba(34,181,255,.65)"/>
      <ellipse cx="285" cy="285" rx="22" ry="16" fill="rgba(34,181,255,.65)"/>
    </g>
  </g>

  <g id="mouths" class="glow">
    <path id="m-neutral" class="m" d="M180 360 Q240 380 300 360" stroke="#22b5ff" stroke-width="12" stroke-linecap="round" fill="none"/>
    <path id="m-happy"    class="m" d="M170 355 Q240 410 310 355" stroke="#22b5ff" stroke-width="14" stroke-linecap="round" fill="none"/>
    <path id="m-sad"      class="m" d="M170 385 Q240 340 310 385" stroke="#22b5ff" stroke-width="12" stroke-linecap="round" fill="none"/>
    <ellipse id="m-o"    class="m" cx="240" cy="365" rx="22" ry="30" fill="#fff"/>
    <line id="m-flat"     class="m" x1="185" y1="365" x2="295" y2="365" stroke="#22b5ff" stroke-width="12" stroke-linecap="round"/>
    <path id="m-angry"    class="m" d="M175 350 L305 350" stroke="#22b5ff" stroke-width="14" stroke-linecap="round"/>
  </g>

  <circle cx="240" cy="320" r="148" fill="none" stroke="rgba(34,181,255,.25)" stroke-width="2" class="glow"/>
</svg>

<script>
const bot=document.getElementById('bot');
function setMood(m){bot.setAttribute('data-state',m);}

function speakText(txt){
  const u=new SpeechSynthesisUtterance(txt);
  const voice=speechSynthesis.getVoices().find(v=>/male|david|daniel|alex/i.test(v.name))||null;
  u.voice=voice; u.pitch=1; u.rate=1;
  u.onstart=()=>setMood('speaking');
  u.onend=()=>setMood('neutral');
  speechSynthesis.speak(u);
}

function cleanText(t){return t.replace(/[*_#`~>]/g,'').trim();}

const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
let rec; if(SR){rec=new SR(); rec.lang='en-US'; rec.interimResults=false;
  rec.onresult=(e)=>{const t=e.results[0][0].transcript.trim(); if(t) handleUserText(t);}
  rec.onend=()=>{}
}

async function handleUserText(text){
  setMood('thinking');
  try{
    const res=await fetch('/.netlify/functions/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({messages:[{role:'user',content:text}]})
    });
    const ai=await res.text();
    setMood('happy'); speakText(cleanText(ai));
  }catch(e){setMood('sad'); speakText("Ooh, my bad—something broke.");}
}

// Start/stop with click or space
let listening=false;
function toggle(){
  if(!rec)return;
  if(listening){rec.stop(); listening=false; setMood('neutral');}
  else{rec.start(); listening=true; setMood('neutral');}
}
document.body.addEventListener('click',toggle);
document.body.addEventListener('keydown',e=>{if(e.code==='Space')toggle();});
</script>
</body>
</html>